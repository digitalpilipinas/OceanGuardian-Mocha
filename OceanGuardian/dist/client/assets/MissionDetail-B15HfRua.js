import{u as Z,j as e,d as g,f as y,g as _,C as j,A as L,a as J,b as z,B as d,k as le,h as V,c as W,D as ce,l as oe,n as de,o as he,p as me,q as xe,r as ue}from"./index-w4qC22aZ.js";import{r as l,f as pe,e as ge}from"./vendor-tuWJg29S.js";import{T as je,a as fe,b as R,c as F}from"./tabs-_ekAYAst.js";import{I as C}from"./input-BK2Frxs7.js";import{L as b}from"./label-D8E2fVe1.js";import{T as ve}from"./textarea-COf4gJas.js";import{f as Ne,O as we,N as P,Y as be,o as K,q as ye,y as _e,l as Ce,b as Q,R as ke,k as Se}from"./ui-DmkW-1mw.js";import"./maps-D8oPmz78.js";function Te({missionId:c}){const{profile:o}=Z(),[x,i]=l.useState([]),[u,k]=l.useState(""),[S,T]=l.useState(!1),p=l.useRef(null),f=async()=>{try{const t=await fetch(`/api/missions/${c}/chat`);t.ok&&i(await t.json())}catch(t){console.error("Failed to fetch messages",t)}};l.useEffect(()=>{f();const t=setInterval(f,5e3);return()=>clearInterval(t)},[c]),l.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[x]);const D=async t=>{if(t.preventDefault(),!(!u.trim()||!o)){T(!0);try{(await fetch(`/api/missions/${c}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:u})})).ok&&(k(""),f())}catch(h){console.error("Failed to send message",h)}finally{T(!1)}}};return e.jsxs(g,{className:"h-[500px] flex flex-col",children:[e.jsx(y,{className:"pb-3 border-b",children:e.jsxs(_,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Mission Chat"]})}),e.jsxs(j,{className:"flex-1 flex flex-col p-0 overflow-hidden",children:[e.jsx("div",{ref:p,className:"flex-1 overflow-y-auto p-4 space-y-4",children:x.length===0?e.jsx("div",{className:"text-center text-muted-foreground py-10",children:e.jsx("p",{children:"No messages yet. Say hello! ðŸ‘‹"})}):x.map(t=>{const h=o?.id===t.user_id;return e.jsxs("div",{className:`flex gap-3 ${h?"flex-row-reverse":""}`,children:[e.jsxs(L,{className:"h-8 w-8",children:[e.jsx(J,{src:t.avatar_url||void 0}),e.jsx(z,{children:t.username?t.username[0]:"?"})]}),e.jsxs("div",{className:`max-w-[80%] rounded-lg p-3 text-sm ${h?"bg-primary text-primary-foreground rounded-tr-none":"bg-muted rounded-tl-none"}`,children:[!h&&e.jsx("p",{className:"text-xs font-semibold mb-1 opacity-70",children:t.username}),e.jsx("p",{children:t.message}),e.jsx("p",{className:"text-[10px] opacity-50 mt-1 text-right",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},t.id)})}),e.jsx("div",{className:"p-4 border-t bg-background",children:e.jsxs("form",{onSubmit:D,className:"flex gap-2",children:[e.jsx(C,{value:u,onChange:t=>k(t.target.value),placeholder:"Type a message...",disabled:S,className:"flex-1"}),e.jsx(d,{type:"submit",size:"icon",disabled:S||!u.trim(),children:e.jsx(we,{className:"h-4 w-4"})})]})})]})]})}function Le(){const{id:c}=pe(),{profile:o}=Z(),x=ge(),{toast:i}=le(),[u,k]=l.useState(null),[S,T]=l.useState(!0),[p,f]=l.useState(!1),[D,t]=l.useState(!1),[h,ee]=l.useState("player"),M=async()=>{try{const s=await fetch(`/api/missions/${c}`);s.ok?k(await s.json()):(i({title:"Error",description:"Mission not found",variant:"destructive"}),x("/missions"))}catch(s){console.error("Failed to fetch mission",s)}finally{T(!1)}};l.useEffect(()=>{c&&M(),o&&fetch("/api/profiles/me").then(s=>s.json()).then(s=>ee(s.role)).catch(()=>{})},[c,x,o]);const se=async()=>{if(o){f(!0);try{const s=await fetch(`/api/missions/${c}/join`,{method:"POST"});if(s.ok)i({title:"Joined!",description:"You have RSVP'd to this mission."}),M();else{const r=await s.json();i({title:"Error",description:r.error,variant:"destructive"})}}catch{i({title:"Error",description:"Failed to join mission",variant:"destructive"})}finally{f(!1)}}},te=async()=>{if(o){if(t(!0),!navigator.geolocation){i({title:"Error",description:"Geolocation not supported",variant:"destructive"}),t(!1);return}navigator.geolocation.getCurrentPosition(async s=>{try{const r=await fetch(`/api/missions/${c}/check-in`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({latitude:s.coords.latitude,longitude:s.coords.longitude})});if(r.ok)i({title:"Checked In!",description:"You are now checked in."}),M();else{const $=await r.json();i({title:"Check-in Failed",description:$.error,variant:"destructive"})}}catch{i({title:"Error",description:"Network error",variant:"destructive"})}finally{t(!1)}},s=>{i({title:"GPS Error",description:"Could not get location. Ensure permissions are granted.",variant:"destructive"}),t(!1)})}};if(S)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-primary"})});if(!u)return null;const{mission:a,participants:m,impact_report:v}=u,B=o?m.find(s=>s.user_id===o.id):null,A=!!B,U=B?.status==="checked_in",N=new Date(a.start_time),E=new Date(a.end_time),I=new Date,ae=I>=N,Y=I>E,G=I>=new Date(N.getTime()-30*6e4)&&I<=E,[re,O]=l.useState(!1),[H,X]=l.useState(!1),[n,w]=l.useState({total_trash_weight:"",trash_bags_count:"",participants_count:"",duration_minutes:"",notes:""}),ie=(o&&a.organizer_id===o.id||h==="admin")&&a.status!=="completed"&&ae,ne=async()=>{X(!0);try{const s={total_trash_weight:parseFloat(n.total_trash_weight),trash_bags_count:parseInt(n.trash_bags_count),participants_count:parseInt(n.participants_count)||m.length,duration_minutes:parseInt(n.duration_minutes),notes:n.notes},r=await fetch(`/api/missions/${c}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(r.ok)i({title:"Mission Completed!",description:"Impact report generated and XP distributed."}),O(!1),M();else{const $=await r.json();i({title:"Error",description:$.error,variant:"destructive"})}}catch(s){console.error(s),i({title:"Error",description:"Failed to complete mission",variant:"destructive"})}finally{X(!1)}},q=[...m].sort((s,r)=>a.status==="completed"?(r.xp_awarded||0)-(s.xp_awarded||0):s.status==="checked_in"&&r.status!=="checked_in"?-1:s.status!=="checked_in"&&r.status==="checked_in"?1:0);return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20 md:pb-8 max-w-4xl",children:[e.jsxs(d,{variant:"ghost",onClick:()=>x("/missions"),className:"mb-4 pl-0",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Back to Missions"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs(je,{defaultValue:"overview",className:"w-full",children:[e.jsxs(fe,{className:"grid w-full grid-cols-3 mb-4",children:[e.jsx(R,{value:"overview",children:"Overview"}),e.jsx(R,{value:"leaderboard",children:"Leaderboard"}),e.jsx(R,{value:"chat",children:"Chat"})]}),e.jsxs(F,{value:"overview",className:"space-y-6",children:[e.jsxs(g,{children:[a.image_url&&e.jsx("div",{className:"relative h-48 w-full overflow-hidden rounded-t-lg",children:e.jsx("img",{src:a.image_url,alt:a.title,className:"w-full h-full object-cover"})}),e.jsx(y,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(_,{className:"text-2xl",children:a.title}),e.jsxs(V,{className:"flex items-center gap-1 mt-1",children:[e.jsx(K,{className:"h-4 w-4"})," ",a.location_name]})]}),e.jsx(W,{variant:a.status==="active"?"default":"secondary",className:"capitalize",children:a.status})]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-4 w-4"}),N.toLocaleDateString()," ",N.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"h-4 w-4"}),Math.round((E.getTime()-N.getTime())/6e4)," mins"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-4 w-4"}),m.length," / ",a.max_participants||"âˆž"]})]}),e.jsx("div",{className:"prose dark:prose-invert",children:e.jsx("p",{children:a.description})}),e.jsxs("div",{className:"flex items-center gap-3 pt-4 border-t",children:[e.jsxs(L,{className:"h-10 w-10",children:[e.jsx(J,{src:a.organizer_avatar}),e.jsx(z,{children:a.organizer_name?.[0]||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Organized by"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.organizer_name||"Unknown"})]}),ie&&e.jsx("div",{className:"ml-auto",children:e.jsxs(ce,{open:re,onOpenChange:O,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(d,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),"Complete Mission"]})}),e.jsxs(de,{children:[e.jsxs(he,{children:[e.jsx(me,{children:"Complete Mission & Report Impact"}),e.jsx(xe,{children:"Submit the final results to distribute XP to participants."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Total Trash (kg)"}),e.jsx(C,{type:"number",step:"0.1",value:n.total_trash_weight,onChange:s=>w({...n,total_trash_weight:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Trash Bags"}),e.jsx(C,{type:"number",value:n.trash_bags_count,onChange:s=>w({...n,trash_bags_count:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Participants"}),e.jsx(C,{type:"number",value:n.participants_count,placeholder:m.length.toString(),onChange:s=>w({...n,participants_count:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Duration (mins)"}),e.jsx(C,{type:"number",value:n.duration_minutes,onChange:s=>w({...n,duration_minutes:s.target.value})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Notes / Highlights"}),e.jsx(ve,{value:n.notes,onChange:s=>w({...n,notes:s.target.value}),placeholder:"What did we achieve? Any weird finds?"})]})]}),e.jsxs(ue,{children:[e.jsx(d,{variant:"outline",onClick:()=>O(!1),children:"Cancel"}),e.jsxs(d,{onClick:ne,disabled:H,children:[H&&e.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Impact Report"]})]})]})]})})]})]})]}),v&&e.jsxs(g,{className:"bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800",children:[e.jsx(y,{children:e.jsx(_,{className:"flex items-center gap-2 text-green-700 dark:text-green-300",children:"Impact Report ðŸŒ"})}),e.jsxs(j,{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-2xl font-bold",children:[v.total_trash_weight," kg"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Trash Removed"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:v.trash_bags_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Bags Filled"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:v.participants_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Participants"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-2xl font-bold",children:[Math.floor(v.duration_minutes),"m"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Duration"})]})]})]})]}),e.jsx(F,{value:"leaderboard",children:e.jsxs(g,{children:[e.jsxs(y,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5 text-amber-500"}),"Mission Leaderboard"]}),e.jsx(V,{children:a.status==="completed"?"Top contributors based on XP earned.":"Participants checked in for this mission."})]}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2",children:q.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No participants yet."}):q.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border bg-card/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`
                                                            flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                                                            ${r===0?"bg-yellow-100 text-yellow-700":r===1?"bg-gray-100 text-gray-700":r===2?"bg-amber-100 text-amber-700":"bg-muted text-muted-foreground"}
                                                        `,children:r+1}),e.jsxs(L,{className:"h-10 w-10",children:[e.jsx(J,{src:s.avatar_url||void 0}),e.jsx(z,{children:s.username?.[0]||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.username||"User"}),s.status==="checked_in"&&e.jsx("p",{className:"text-xs text-green-600",children:"Checked In"})]})]}),a.status==="completed"&&s.xp_awarded>0&&e.jsxs(W,{variant:"secondary",className:"bg-yellow-50 text-yellow-700 border-yellow-200",children:["+",s.xp_awarded," XP"]})]},s.user_id))})})]})}),e.jsx(F,{value:"chat",children:A?e.jsx("div",{className:"h-[500px] border rounded-lg overflow-hidden",children:e.jsx(Te,{missionId:Number(c)})}):e.jsx(g,{children:e.jsx(j,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Join the mission to access the chat."})})})})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(g,{children:[e.jsx(y,{children:e.jsx(_,{children:"Your Status"})}),e.jsx(j,{className:"space-y-4",children:A?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600 bg-green-50 dark:bg-green-900/20 p-3 rounded-lg",children:[e.jsx(ke,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"You're attending!"})]}),U?e.jsx(d,{variant:"outline",className:"w-full cursor-default",disabled:!0,children:"Checked In âœ…"}):e.jsxs(d,{className:"w-full",onClick:te,disabled:D||!G,children:[D?e.jsx(P,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(K,{className:"h-4 w-4 mr-2"}),"Check-in (GPS)"]}),!U&&!G&&!Y&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Check-in opens 30 mins before start."})]}):e.jsxs(d,{className:"w-full",onClick:se,disabled:p||Y||(a.max_participants?m.length>=a.max_participants:!1),children:[p?e.jsx(P,{className:"h-4 w-4 animate-spin mr-2"}):null,"RSVP / Join Mission"]})})]}),e.jsx(g,{children:e.jsx(j,{className:"p-4",children:e.jsxs(d,{variant:"outline",className:"w-full",onClick:async()=>{console.log("[analytics] mission_share_clicked");const s=`Join the "${a.title}" cleanup mission on OceanGuardian! ðŸŒŠ ${m.length} guardian${m.length!==1?"s":""} already signed up.`;if(navigator.share)try{await navigator.share({title:a.title,text:s,url:window.location.href})}catch(r){console.error("Share failed",r)}else await navigator.clipboard.writeText(`${s}
${window.location.href}`),i({title:"Copied!",description:"Mission link copied to clipboard."})},children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Invite Friends"]})})})]})]})]})}export{Le as default};
