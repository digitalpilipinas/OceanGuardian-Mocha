import{u as V,i as Y,j as e,C as L,a as E,b as G,c as T,g as v}from"./index-BVp5WuMy.js";import{e as Q,r as n}from"./vendor-DvMla3zT.js";import{I as y}from"./input-B6XB6uRj.js";import{T as Z}from"./textarea-or-DUBcO.js";import{L as c}from"./label-BHE2YM-5.js";import{S as ee,a as te,b as ae,c as se,d as re}from"./select-CqnXjh7w.js";import{H as oe,J as ie,q as le,r as ne,s as ce,W as q,v as de,w as me,x as pe,y as he,E as H,K as xe,l as ge}from"./ui-CRTwZCWL.js";import"./maps-DK6RsE9k.js";import"./index-BdQq_4o_.js";import"./index-DuD6u1I3.js";const ue=[{value:"garbage",label:"Beach Garbage",icon:le,color:"text-red-500",bg:"bg-red-50 dark:bg-red-950/30",border:"border-red-200 dark:border-red-800",activeBg:"bg-red-100 dark:bg-red-900/50",emoji:"üóëÔ∏è"},{value:"floating",label:"Floating Trash",icon:ne,color:"text-orange-500",bg:"bg-orange-50 dark:bg-orange-950/30",border:"border-orange-200 dark:border-orange-800",activeBg:"bg-orange-100 dark:bg-orange-900/50",emoji:"üö¢"},{value:"wildlife",label:"Wildlife",icon:ce,color:"text-green-500",bg:"bg-green-50 dark:bg-green-950/30",border:"border-green-200 dark:border-green-800",activeBg:"bg-green-100 dark:bg-green-900/50",emoji:"üê¢"},{value:"coral",label:"Coral Health",icon:q,color:"text-pink-500",bg:"bg-pink-50 dark:bg-pink-950/30",border:"border-pink-200 dark:border-pink-800",activeBg:"bg-pink-100 dark:bg-pink-900/50",emoji:"ü™∏"}],be={garbage:["Plastic bottle","Plastic bag","Food wrapper","Cigarette butt","Fishing line","Other"],floating:["Ghost net","Plastic debris","Oil spill","Large trash","Microplastics","Other"],wildlife:["Sea turtle","Dolphin","Whale","Fish","Seabird","Jellyfish","Other"],coral:["Bleached coral","Damaged coral","Healthy coral","Algae overgrowth","Other"]},je=[{value:1,emoji:"üü¢",label:"Minor"},{value:2,emoji:"üü°",label:"Low"},{value:3,emoji:"üü†",label:"Moderate"},{value:4,emoji:"üî¥",label:"Serious"},{value:5,emoji:"üö®",label:"Critical"}];async function fe(p,h=1024){return p.size<=h*1024?p:new Promise(S=>{const x=new Image;x.onload=()=>{const g=document.createElement("canvas");let{width:a,height:s}=x;const o=1920;(a>o||s>o)&&(a>s?(s=s*o/a,a=o):(a=a*o/s,s=o)),g.width=a,g.height=s,g.getContext("2d").drawImage(x,0,0,a,s);let u=.8;const b=()=>{g.toBlob(f=>{f&&(f.size<=h*1024||u<=.3)?S(new File([f],p.name,{type:"image/jpeg"})):(u-=.1,b())},"image/jpeg",u)};b()},x.src=URL.createObjectURL(p)})}function Te(){const p=Q(),{profile:h}=V(),S=()=>window.location.href="/login",{triggerLevelUp:x,triggerBadgeUnlock:g}=Y(),[a,s]=n.useState({type:"",subcategory:"",description:"",severity:3,location:"",waterTemp:"",bleachPercent:"",depth:""}),[o,N]=n.useState(null),[u,b]=n.useState(null),[f,R]=n.useState(!1),[D,w]=n.useState(!1),[$,F]=n.useState(!1),[I,M]=n.useState(null),[B,W]=n.useState(0);if(n.useEffect(()=>{h&&fetch("/api/profiles/me").then(t=>t.ok?t.json():null).then(t=>{t?.level&&W(t.level)}).catch(()=>{})},[h]),n.useEffect(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(t=>{s(r=>({...r,location:`${t.coords.latitude.toFixed(6)}, ${t.coords.longitude.toFixed(6)}`}))},()=>{})},[]),!h)return e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsxs(L,{className:"max-w-md mx-auto",children:[e.jsx(E,{className:"text-center",children:e.jsx(G,{className:"text-2xl",children:"Sign in to report a sighting"})}),e.jsxs(T,{className:"space-y-4",children:[e.jsx("p",{className:"text-center text-muted-foreground",children:"You need to be signed in to report marine sightings"}),e.jsx(v,{onClick:()=>S(),className:"w-full",size:"lg",children:"Get Started"})]})]})});const z=async t=>{const r=t.target.files?.[0];if(r){R(!0);try{const l=await fe(r);N(l);const j=new FileReader;j.onloadend=()=>b(j.result),j.readAsDataURL(l)}catch{N(r);const l=new FileReader;l.onloadend=()=>b(l.result),l.readAsDataURL(r)}finally{R(!1)}}},J=()=>{w(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{s(r=>({...r,location:`${t.coords.latitude.toFixed(6)}, ${t.coords.longitude.toFixed(6)}`})),w(!1)},()=>{w(!1),alert("Unable to get your location. Please enter it manually.")}):(w(!1),alert("Geolocation is not supported by your browser"))},X=async t=>{t.preventDefault(),F(!0);try{const[r,l]=a.location.split(",").map(i=>i.trim()),j=parseFloat(r),U=parseFloat(l);if(isNaN(j)||isNaN(U)){alert("Invalid location format. Use: latitude, longitude"),F(!1);return}const C={type:a.type,subcategory:a.subcategory,description:a.description,severity:a.severity,latitude:j,longitude:U};a.type==="coral"&&(a.waterTemp&&(C.water_temp=parseFloat(a.waterTemp)),a.bleachPercent&&(C.bleach_percent=parseInt(a.bleachPercent)),a.depth&&(C.depth=parseFloat(a.depth)));const P=await fetch("/api/sightings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!P.ok){const i=await P.json();throw new Error(i.error||"Failed to submit sighting")}const m=await P.json(),O=m.sighting?.id;let _=m.xp_earned||0;if(o&&O){const i=new FormData;i.append("photo",o);const A=await fetch(`/api/sightings/${O}/photo`,{method:"POST",body:i});if(A.ok){const K=await A.json();_+=K.xp_bonus||0}}if(M({xp:_}),m.leveled_up&&x(m.old_level,m.new_level),m.new_badges&&Array.isArray(m.new_badges))for(const i of m.new_badges)g({name:i.name,description:i.description,icon:i.icon,rarity:i.rarity,category:i.category});setTimeout(()=>p("/map"),3e3)}catch(r){console.error("Submit error:",r),alert(r instanceof Error?r.message:"Failed to submit sighting"),F(!1)}};if(I)return e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsx(L,{className:"max-w-md mx-auto overflow-hidden",children:e.jsxs(T,{className:"p-8 text-center space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"bg-green-100 dark:bg-green-900/20 p-4 rounded-full animate-bounce",children:e.jsx(oe,{className:"h-12 w-12 text-green-500"})})}),e.jsx("h2",{className:"text-2xl font-bold",children:"Sighting Reported! üéâ"}),e.jsx("p",{className:"text-muted-foreground",children:"Thank you for helping protect our oceans"}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-4",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["+",I.xp," XP"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Experience earned"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Redirecting to map..."})]})})});const k=a.type==="coral",d=k&&B<6;return e.jsx("div",{className:"container mx-auto px-4 py-8 pb-24 md:pb-8 max-w-2xl",children:e.jsxs(L,{children:[e.jsxs(E,{children:[e.jsxs(G,{className:"text-2xl flex items-center gap-2",children:[e.jsx(ie,{className:"h-6 w-6 text-primary"}),"Report a Sighting"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Help protect our oceans by reporting what you see"})]}),e.jsx(T,{children:e.jsxs("form",{onSubmit:X,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"What did you find? *"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:ue.map(t=>{const r=t.icon,l=a.type===t.value;return e.jsxs("button",{type:"button",onClick:()=>s({...a,type:t.value,subcategory:""}),className:`
                        relative flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all duration-200
                        ${l?`${t.activeBg} ${t.border} ring-2 ring-offset-1 ring-current ${t.color} scale-[1.02] shadow-md`:`${t.bg} border-transparent hover:${t.border} hover:shadow-sm`}
                      `,children:[e.jsx("span",{className:"text-2xl",children:t.emoji}),e.jsx(r,{className:`h-5 w-5 ${t.color}`}),e.jsx("span",{className:"text-xs font-medium",children:t.label}),l&&e.jsx("div",{className:`absolute top-1.5 right-1.5 w-2.5 h-2.5 rounded-full ${t.color.replace("text-","bg-")}`})]},t.value)})})]}),d&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(de,{className:"h-5 w-5 text-amber-500 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-200",children:"Level 6 Required"}),e.jsxs("p",{className:"text-xs text-amber-600 dark:text-amber-400 mt-1",children:["Coral health reports require Level 6+ for accuracy. You're currently Level ",B,". Keep reporting other sightings to level up!"]})]})]}),a.type&&!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"subcategory",children:"Specific Type *"}),e.jsxs(ee,{value:a.subcategory,onValueChange:t=>s({...a,subcategory:t}),children:[e.jsx(te,{id:"subcategory",children:e.jsx(ae,{placeholder:"Select specific type..."})}),e.jsx(se,{children:(be[a.type]||[]).map(t=>e.jsx(re,{value:t,children:t},t))})]})]}),k&&!d&&e.jsxs("div",{className:"space-y-4 bg-pink-50/50 dark:bg-pink-950/10 rounded-lg p-4 border border-pink-100 dark:border-pink-900/30",children:[e.jsxs("h3",{className:"text-sm font-semibold flex items-center gap-2 text-pink-700 dark:text-pink-300",children:[e.jsx(q,{className:"h-4 w-4"})," Coral Health Data"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(c,{htmlFor:"waterTemp",className:"text-xs flex items-center gap-1",children:[e.jsx(me,{className:"h-3 w-3"})," Temp (¬∞C)"]}),e.jsx(y,{id:"waterTemp",type:"number",step:"0.1",min:"0",max:"50",placeholder:"28.5",value:a.waterTemp,onChange:t=>s({...a,waterTemp:t.target.value}),className:"h-9 text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(c,{htmlFor:"bleachPercent",className:"text-xs flex items-center gap-1",children:[e.jsx(pe,{className:"h-3 w-3"})," Bleach %"]}),e.jsx(y,{id:"bleachPercent",type:"number",min:"0",max:"100",placeholder:"40",value:a.bleachPercent,onChange:t=>s({...a,bleachPercent:t.target.value}),className:"h-9 text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(c,{htmlFor:"depth",className:"text-xs flex items-center gap-1",children:[e.jsx(he,{className:"h-3 w-3"})," Depth (m)"]}),e.jsx(y,{id:"depth",type:"number",step:"0.5",min:"0",max:"100",placeholder:"5",value:a.depth,onChange:t=>s({...a,depth:t.target.value}),className:"h-9 text-sm"})]})]})]}),a.type&&!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"photo",children:["Photo ",k?"* (Required for coral)":"(Optional, +5 XP)"]}),e.jsx("div",{className:"space-y-3",children:u?e.jsxs("div",{className:"relative rounded-lg overflow-hidden border",children:[e.jsx("img",{src:u,alt:"Preview",className:"w-full h-64 object-cover"}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2",children:[o&&e.jsxs("span",{className:"bg-black/60 text-white text-xs px-2 py-1 rounded",children:[(o.size/1024).toFixed(0)," KB"]}),e.jsx(v,{type:"button",variant:"secondary",size:"sm",onClick:()=>{N(null),b(null)},children:"Remove"})]})]}):e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer",children:[e.jsx("label",{htmlFor:"photo",className:"cursor-pointer block",children:f?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-12 w-12 mx-auto text-primary mb-2 animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Compressing image..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-12 w-12 mx-auto text-muted-foreground mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Click to upload or take a photo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-compressed to < 1MB"})]})}),e.jsx(y,{id:"photo",type:"file",accept:"image/*",capture:"environment",className:"hidden",onChange:z})]})})]}),a.type&&!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"description",children:"Description *"}),e.jsx(Z,{id:"description",placeholder:"Describe what you observed in detail...",value:a.description,onChange:t=>s({...a,description:t.target.value}),rows:3,maxLength:500}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[a.description.length,"/500"]})]}),a.type&&!d&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(c,{children:"Severity / Importance"}),e.jsx("div",{className:"flex items-center justify-between gap-1",children:je.map(t=>e.jsxs("button",{type:"button",onClick:()=>s({...a,severity:t.value}),className:`
                        flex flex-col items-center gap-1 px-3 py-2 rounded-lg transition-all duration-200 flex-1
                        ${a.severity===t.value?"bg-primary/10 ring-2 ring-primary scale-105":"hover:bg-muted"}
                      `,children:[e.jsx("span",{className:`text-xl ${a.severity===t.value?"scale-125":""} transition-transform`,children:t.emoji}),e.jsx("span",{className:"text-[10px] font-medium",children:t.label})]},t.value))})]}),a.type&&!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"location",children:"Location *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{id:"location",placeholder:"Latitude, Longitude",value:a.location,onChange:t=>s({...a,location:t.target.value}),className:"flex-1"}),e.jsxs(v,{type:"button",variant:"outline",onClick:J,disabled:D,children:[e.jsx(ge,{className:"h-4 w-4 mr-1"}),D?"Getting...":"GPS"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use GPS to automatically capture your current location"})]}),a.type&&!d&&e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>p("/map"),className:"flex-1",children:"Cancel"}),e.jsx(v,{type:"submit",className:"flex-1",disabled:$||!a.type||!a.subcategory||!a.description||!a.location||k&&!o,children:$?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-4 w-4 mr-2 animate-spin"}),"Submitting..."]}):"Submit Report"})]})]})})]})})}export{Te as default};
