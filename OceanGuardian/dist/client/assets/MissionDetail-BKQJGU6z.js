import{u as Z,j as e,C as j,a as y,b as _,c as f,A as F,d as J,e as $,g as m,k as le,f as q,B as Q,D as ce,l as oe,n as de,o as me,p as he,q as xe,r as ue}from"./index-B2j6MuZ4.js";import{r as n,f as pe,e as ge}from"./vendor-DvMla3zT.js";import{T as je,a as fe,b as R,c as z}from"./tabs-XCwY5kzE.js";import{I as C}from"./input-B1Ip_IAF.js";import{L as w}from"./label-mzl3PxXF.js";import{T as ve}from"./textarea-CNVlLn-j.js";import{M as Ne,z as be,E as P,N as we,l as W,C as ye,u as _e,i as Ce,Q as K,H as ke}from"./ui-CRTwZCWL.js";import"./maps-DK6RsE9k.js";function Se({missionId:c}){const{profile:o}=Z(),[h,l]=n.useState([]),[x,k]=n.useState(""),[S,T]=n.useState(!1),u=n.useRef(null),p=async()=>{try{const t=await fetch(`/api/missions/${c}/chat`);t.ok&&l(await t.json())}catch(t){console.error("Failed to fetch messages",t)}};n.useEffect(()=>{p();const t=setInterval(p,5e3);return()=>clearInterval(t)},[c]),n.useEffect(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[h]);const D=async t=>{if(t.preventDefault(),!(!x.trim()||!o)){T(!0);try{(await fetch(`/api/missions/${c}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:x})})).ok&&(k(""),p())}catch(d){console.error("Failed to send message",d)}finally{T(!1)}}};return e.jsxs(j,{className:"h-[500px] flex flex-col",children:[e.jsx(y,{className:"pb-3 border-b",children:e.jsxs(_,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Mission Chat"]})}),e.jsxs(f,{className:"flex-1 flex flex-col p-0 overflow-hidden",children:[e.jsx("div",{ref:u,className:"flex-1 overflow-y-auto p-4 space-y-4",children:h.length===0?e.jsx("div",{className:"text-center text-muted-foreground py-10",children:e.jsx("p",{children:"No messages yet. Say hello! ðŸ‘‹"})}):h.map(t=>{const d=o?.id===t.user_id;return e.jsxs("div",{className:`flex gap-3 ${d?"flex-row-reverse":""}`,children:[e.jsxs(F,{className:"h-8 w-8",children:[e.jsx(J,{src:t.avatar_url||void 0}),e.jsx($,{children:t.username?t.username[0]:"?"})]}),e.jsxs("div",{className:`max-w-[80%] rounded-lg p-3 text-sm ${d?"bg-primary text-primary-foreground rounded-tr-none":"bg-muted rounded-tl-none"}`,children:[!d&&e.jsx("p",{className:"text-xs font-semibold mb-1 opacity-70",children:t.username}),e.jsx("p",{children:t.message}),e.jsx("p",{className:"text-[10px] opacity-50 mt-1 text-right",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},t.id)})}),e.jsx("div",{className:"p-4 border-t bg-background",children:e.jsxs("form",{onSubmit:D,className:"flex gap-2",children:[e.jsx(C,{value:x,onChange:t=>k(t.target.value),placeholder:"Type a message...",disabled:S,className:"flex-1"}),e.jsx(m,{type:"submit",size:"icon",disabled:S||!x.trim(),children:e.jsx(be,{className:"h-4 w-4"})})]})})]})]})}function ze(){const{id:c}=pe(),{profile:o}=Z(),h=ge(),{toast:l}=le(),[x,k]=n.useState(null),[S,T]=n.useState(!0),[u,p]=n.useState(!1),[D,t]=n.useState(!1),[d,ee]=n.useState("player"),M=async()=>{try{const s=await fetch(`/api/missions/${c}`);s.ok?k(await s.json()):(l({title:"Error",description:"Mission not found",variant:"destructive"}),h("/missions"))}catch(s){console.error("Failed to fetch mission",s)}finally{T(!1)}};n.useEffect(()=>{c&&M(),o&&fetch("/api/profiles/me").then(s=>s.json()).then(s=>ee(s.role)).catch(()=>{})},[c,h,o]);const se=async()=>{if(o){p(!0);try{const s=await fetch(`/api/missions/${c}/join`,{method:"POST"});if(s.ok)l({title:"Joined!",description:"You have RSVP'd to this mission."}),M();else{const r=await s.json();l({title:"Error",description:r.error,variant:"destructive"})}}catch{l({title:"Error",description:"Failed to join mission",variant:"destructive"})}finally{p(!1)}}},te=async()=>{if(o){if(t(!0),!navigator.geolocation){l({title:"Error",description:"Geolocation not supported",variant:"destructive"}),t(!1);return}navigator.geolocation.getCurrentPosition(async s=>{try{const r=await fetch(`/api/missions/${c}/check-in`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({latitude:s.coords.latitude,longitude:s.coords.longitude})});if(r.ok)l({title:"Checked In!",description:"You are now checked in."}),M();else{const L=await r.json();l({title:"Check-in Failed",description:L.error,variant:"destructive"})}}catch{l({title:"Error",description:"Network error",variant:"destructive"})}finally{t(!1)}},s=>{l({title:"GPS Error",description:"Could not get location. Ensure permissions are granted.",variant:"destructive"}),t(!1)})}};if(S)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-primary"})});if(!x)return null;const{mission:a,participants:g,impact_report:v}=x,B=o?g.find(s=>s.user_id===o.id):null,A=!!B,H=B?.status==="checked_in",N=new Date(a.start_time),E=new Date(a.end_time),I=new Date,ae=I>=N,U=I>E,X=I>=new Date(N.getTime()-30*6e4)&&I<=E,[re,O]=n.useState(!1),[Y,G]=n.useState(!1),[i,b]=n.useState({total_trash_weight:"",trash_bags_count:"",participants_count:"",duration_minutes:"",notes:""}),ie=(o&&a.organizer_id===o.id||d==="admin")&&a.status!=="completed"&&ae,ne=async()=>{G(!0);try{const s={total_trash_weight:parseFloat(i.total_trash_weight),trash_bags_count:parseInt(i.trash_bags_count),participants_count:parseInt(i.participants_count)||g.length,duration_minutes:parseInt(i.duration_minutes),notes:i.notes},r=await fetch(`/api/missions/${c}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(r.ok)l({title:"Mission Completed!",description:"Impact report generated and XP distributed."}),O(!1),M();else{const L=await r.json();l({title:"Error",description:L.error,variant:"destructive"})}}catch(s){console.error(s),l({title:"Error",description:"Failed to complete mission",variant:"destructive"})}finally{G(!1)}},V=[...g].sort((s,r)=>a.status==="completed"?(r.xp_awarded||0)-(s.xp_awarded||0):s.status==="checked_in"&&r.status!=="checked_in"?-1:s.status!=="checked_in"&&r.status==="checked_in"?1:0);return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20 md:pb-8 max-w-4xl",children:[e.jsxs(m,{variant:"ghost",onClick:()=>h("/missions"),className:"mb-4 pl-0",children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Back to Missions"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs(je,{defaultValue:"overview",className:"w-full",children:[e.jsxs(fe,{className:"grid w-full grid-cols-3 mb-4",children:[e.jsx(R,{value:"overview",children:"Overview"}),e.jsx(R,{value:"leaderboard",children:"Leaderboard"}),e.jsx(R,{value:"chat",children:"Chat"})]}),e.jsxs(z,{value:"overview",className:"space-y-6",children:[e.jsxs(j,{children:[a.image_url&&e.jsx("div",{className:"relative h-48 w-full overflow-hidden rounded-t-lg",children:e.jsx("img",{src:a.image_url,alt:a.title,className:"w-full h-full object-cover"})}),e.jsx(y,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(_,{className:"text-2xl",children:a.title}),e.jsxs(q,{className:"flex items-center gap-1 mt-1",children:[e.jsx(W,{className:"h-4 w-4"})," ",a.location_name]})]}),e.jsx(Q,{variant:a.status==="active"?"default":"secondary",className:"capitalize",children:a.status})]})}),e.jsxs(f,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-4 w-4"}),N.toLocaleDateString()," ",N.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"h-4 w-4"}),Math.round((E.getTime()-N.getTime())/6e4)," mins"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-4 w-4"}),g.length," / ",a.max_participants||"âˆž"]})]}),e.jsx("div",{className:"prose dark:prose-invert",children:e.jsx("p",{children:a.description})}),e.jsxs("div",{className:"flex items-center gap-3 pt-4 border-t",children:[e.jsxs(F,{className:"h-10 w-10",children:[e.jsx(J,{src:a.organizer_avatar}),e.jsx($,{children:a.organizer_name?.[0]||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Organized by"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.organizer_name||"Unknown"})]}),ie&&e.jsx("div",{className:"ml-auto",children:e.jsxs(ce,{open:re,onOpenChange:O,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(m,{variant:"default",className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Complete Mission"]})}),e.jsxs(de,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"Complete Mission & Report Impact"}),e.jsx(xe,{children:"Submit the final results to distribute XP to participants."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Total Trash (kg)"}),e.jsx(C,{type:"number",step:"0.1",value:i.total_trash_weight,onChange:s=>b({...i,total_trash_weight:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Trash Bags"}),e.jsx(C,{type:"number",value:i.trash_bags_count,onChange:s=>b({...i,trash_bags_count:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Participants"}),e.jsx(C,{type:"number",value:i.participants_count,placeholder:g.length.toString(),onChange:s=>b({...i,participants_count:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Duration (mins)"}),e.jsx(C,{type:"number",value:i.duration_minutes,onChange:s=>b({...i,duration_minutes:s.target.value})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Notes / Highlights"}),e.jsx(ve,{value:i.notes,onChange:s=>b({...i,notes:s.target.value}),placeholder:"What did we achieve? Any weird finds?"})]})]}),e.jsxs(ue,{children:[e.jsx(m,{variant:"outline",onClick:()=>O(!1),children:"Cancel"}),e.jsxs(m,{onClick:ne,disabled:Y,children:[Y&&e.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Impact Report"]})]})]})]})})]})]})]}),v&&e.jsxs(j,{className:"bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800",children:[e.jsx(y,{children:e.jsx(_,{className:"flex items-center gap-2 text-green-700 dark:text-green-300",children:"Impact Report ðŸŒ"})}),e.jsxs(f,{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-2xl font-bold",children:[v.total_trash_weight," kg"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Trash Removed"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:v.trash_bags_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Bags Filled"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:v.participants_count}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Participants"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-2xl font-bold",children:[Math.floor(v.duration_minutes),"m"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Duration"})]})]})]})]}),e.jsx(z,{value:"leaderboard",children:e.jsxs(j,{children:[e.jsxs(y,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 text-amber-500"}),"Mission Leaderboard"]}),e.jsx(q,{children:a.status==="completed"?"Top contributors based on XP earned.":"Participants checked in for this mission."})]}),e.jsx(f,{children:e.jsx("div",{className:"space-y-2",children:V.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No participants yet."}):V.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border bg-card/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`
                                                            flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm
                                                            ${r===0?"bg-yellow-100 text-yellow-700":r===1?"bg-gray-100 text-gray-700":r===2?"bg-amber-100 text-amber-700":"bg-muted text-muted-foreground"}
                                                        `,children:r+1}),e.jsxs(F,{className:"h-10 w-10",children:[e.jsx(J,{src:s.avatar_url||void 0}),e.jsx($,{children:s.username?.[0]||"?"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.username||"User"}),s.status==="checked_in"&&e.jsx("p",{className:"text-xs text-green-600",children:"Checked In"})]})]}),a.status==="completed"&&s.xp_awarded>0&&e.jsxs(Q,{variant:"secondary",className:"bg-yellow-50 text-yellow-700 border-yellow-200",children:["+",s.xp_awarded," XP"]})]},s.user_id))})})]})}),e.jsx(z,{value:"chat",children:A?e.jsx("div",{className:"h-[500px] border rounded-lg overflow-hidden",children:e.jsx(Se,{missionId:Number(c)})}):e.jsx(j,{children:e.jsx(f,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Join the mission to access the chat."})})})})]})}),e.jsx("div",{className:"space-y-6",children:e.jsxs(j,{children:[e.jsx(y,{children:e.jsx(_,{children:"Your Status"})}),e.jsx(f,{className:"space-y-4",children:A?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600 bg-green-50 dark:bg-green-900/20 p-3 rounded-lg",children:[e.jsx(ke,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"You're attending!"})]}),H?e.jsx(m,{variant:"outline",className:"w-full cursor-default",disabled:!0,children:"Checked In âœ…"}):e.jsxs(m,{className:"w-full",onClick:te,disabled:D||!X,children:[D?e.jsx(P,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(W,{className:"h-4 w-4 mr-2"}),"Check-in (GPS)"]}),!H&&!X&&!U&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Check-in opens 30 mins before start."})]}):e.jsxs(m,{className:"w-full",onClick:se,disabled:u||U||(a.max_participants?g.length>=a.max_participants:!1),children:[u?e.jsx(P,{className:"h-4 w-4 animate-spin mr-2"}):null,"RSVP / Join Mission"]})})]})})]})]})}export{ze as default};
